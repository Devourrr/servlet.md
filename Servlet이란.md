### Servlet이란?

- 자바 웹 api의 구성요소
  - 동적인 처리를 하는 프로그램의 역할

- WAS에서 동작하는 Java클래스이다

- HTTPServlet 클래스를 상속받아야 한다

- 서블릿과 JSP로부터 최상의 결과를 얻으려면, 웹 페이지를 개발할 때 이 두가지를 조화롭게 사용해야 한다

  - ex) 웹 페이지를 구성하는 화면(HTML)은 JSP로 표현하고, 복잡한 프로그래밍은 Servlet으로 구현

    

개발자가 스스로 모든 것을 제어하는게 아니라 WAS등의 외부 도움을 받아야 할 땐 정해진 약속을 따라야 한다.

자바 웹 어플리케이션도 마찬가지로 정해진 약속이 있다

![](C:\Users\CJH\Desktop\md\img\java web구조.jpg)



web-inf폴더가 반드시 존재해야 하며 

그 안에는**web.xml**(배포 기술자, web api의 정보를 다 가지고 있음)도 굉장히 중요하다.

sevlet 3.0미만에서는 필수였으나 3.0이상에선 어노테이션 사용해서 대신해줄수 있게 되었다(하지만 꼭 알야야 함)

web-inf폴더의 하위 폴더로 lib(jar파일들), classes폴더(java패키지, 클래스들)가 존재한다



현재 프로젝트에서 웹 개발시 서블릿을 직접 써서 개발하지는 않고

조금 더 편하게 사용할 수 있도록 도와주는 다양한 프레임워크를 대부분 사용한다

하지만 그 프레임워크들도 서블릿 없이는 동작할 수 없기 때문에 기본적인 작성법이나,

서블릿의 라이프 사이클을 이해하고 있다면 웹의 동작을 이해하는데 도움이 많이 된다.



**버전에 따른 Servlet 작성 방법**

**1. Servlet 3.0 spec 이상에서 사용하는 방법**

- web.xml 파일을 사용하지 않고 자바 어노테이션(annotation)을 사용

**2. Servlet 3.0 spec미만에서 사용하는 방법**

- servlet을 등록할 때 web.xml 파일에 등록



##  텐서블릿(1~10출력하는 서블릿) 작성해보기

1. 다이나믹 웹 프로젝트 생성 - 다이나믹 웹 모듈 버전 3.1이상 선택 -

    2버전 아니기 때문에 web.xml직접 등록이 아닌 어노테이션 사용하지만 나중에 스프링에선

   서블릿을 3버전으로 만들었다 하러다도 다른 설정 부분을 web.xml에 추가할 필요가 있음(그 때는 반드시 생성에 체크)

2. 프로젝트에 서블릿 생성 - 패키지/클래스 생성 - url맵핑 - 메서드설정 -- doGet메서드 변경
3. 서블릿은 동적으로 응답 결과를 만들어내는 것이기 때문에 이미 응답할 페이지를 가지고 있는게 아니라 요청이 들어왔을 때 이 프로그램이 실행되면서 응답할 코드를 만들어내고 그 때 그 코드로 응답하는 것
4.  respone객체로 응답, setContentType으로 브라우저에게 이미지인지 동영상, 텍스트인지 알려주면 브라우저는 그것을 해석함
5. 타입을 정했으면 내용을 넣어줄 통로를 생성하기 위해 response객채의 getWriter메서드사용(PrintWirter객체 리턴)
6. PrintWriter객체의 println메서드 사용해서 for문 소스코드(br태그 포함 반복)
7. for문 밖에서 out.close();



```java
@WebServlet("/10") // 어노테이션으로 웹 서블릿 만들어짐(url에 따라 요청주소값 달라짐, 변경 가능)

protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		response.setContentType("text/html; charset=utf-8");
		PrintWriter out = response.getWriter();
		out.println("<h1>1~10까지 출력<h1>");
		for(int i=1; i<=10; i++) {
			out.print(i+"<br>");
		}
```





##  서블릿 3.0미만 작성법

1. 다이나믹 웹 프로젝트 - 모듈2.5- web.xml생성(lib폴더 하위에 위치) - 서블릿 동일하게 생성
2. 클래스 위 쪽에 어노테이션이 보이지 않음
3. doget메소드 동일하게 작성
4. url을 살펴보면 프로토콜/도메인/포트번호/프로젝트네임/url로 구성된걸 확인할 수 있음
5. url변경 희망시 url-pattern태그를 조작, web.xml파일이 바뀌면 서버를 꼭 리스타트
6. 버전에 따라 서블릿 등록법은 다를 수 있다



###  서블릿 라이플사이클

서블릿은 언제 생성되고 어떤 메스드를 호출할까?



examples패키지에서 서블릿 클래스를 생성해서 init, destroy, service메서드를 오버라이드해보자

(doGet,doPost제외)

처음 요청할 때 어떤 메서드들이 실행되는지 살펴보면

두번째에는 어떤 메서드가 실행되는지, 애플리케이션 자체가 변경됐을때는 어떤 메서드가 실행되는지 확인해보자

정리를 해보자면

![](C:\Users\CJH\Desktop\md\img\lifecycle.jpg)



서블릿이 처음 호출되면 init()메서드가 호출, 그리고 service()라는 메서드 호출

destroy()메서드는 항상 호출되지 않고 웹 api가 갱신되거나 WAS가 종료될 때 호출됨을 알 수 있다.

WAS는 서블릿의 요청을 받으면 일단 해당 서블릿이 메모리에 있는지 유무를 확인하게 되고

만약 메모리에 없다면 해당 서블릿 클래스를 메모리에 올리는 작업을 하게 된다.

이 메모리에 올리는 작업은 객체가 생성되는 작업이라고 볼 수 있다.

그런 이유로 처음 요청했을 때 생성자의 메시지 부분이 출력됐었고,

그 다음 init()이라는 메서드와 service()메소드가 호출됨

두 번째 요청이 들어왔을 때는 생성자와 init()메서드는 호출되지않고 service()라는 메서드만 계속 실행됨

**요청이 들어왔을 때 응답해야 되는 모든 내용은 service()라는 메서드에 구현해야되겠구나를 이해하면 된다**

**Servlet 생명주기**

- WAS는 서블릿 요청을 받으면 해당 서블릿이 메모리에 있는지 확인
-  if (메모리에 없음) {
   \- 해당 서블릿 클래스를 메모리에 올림
   \- init() 메소드를 실행
  }
   \- service()메소드를 실행
- was가 종료되거나, 웹 어플리케이션이 새롭게 갱신될 경우 destroy() 메소드가 실행

WAS가 종료되거나 웹 api가 새로 갱신될 경우에만 destroy()메서드가 실행이 된다.

그런데 이전에 doGet()메서드만으로 실행이 잘 되었던 건 뭘까?

분명히 WAS는 init()이라는 메서드를 호출하고 다음은 service()라는 메서드를 호출하는 예만 수행하는데

doGet()이라는 메서드는 어떻게 실행되었을까?

정확히는 모르겠지만 service()라는 녀석이 조금 특이한 녀석이란 걸 알 수 있다.



service(request, response)메소드

내가 만든 클래스가 service()라는 메서드를 갖고 있지 않다면 

나의 부모 클래스의 service()라는 메서드가 상속되어 실행된다. 

즉 내가 service를 오버라이드하지 않았다면 서블릿의 부모인 HttpServlet의 메소드로써 실행이 된다.

그렇다면 HttpServlet의 service()메서드는 어떻게 구현이 되어있을까?



- HTTPServlet의 service메소드는 템플릿 메소드 패턴으로 구현되어 있는 상태
  - 클라이언트의 요청이 GET일 경우 자신이 가지고 있는 doGet(request, response)메소드 호출
  - 클라이언트의 요청이 Post일 경우 자신이 가지고 있는 doPost(request, response)를 호출





### Request, Response 객체 이해하기

웹 브라우저에 URL을 입력하면 도메인과 포트번호를 이용해서 서버에 접속하고,

클라이언트의 다양한 정보(path정보, IP..)를 포함한 요청 정보를 서버에게 전송하게 된다.

자바는 객체지향 언어라는 것을 상기해보자.

객체는 관련된 정보를 모아서 가지고 있는 특징이 있다.

클라이언트로부터 요청이 들어올 때 WAS도 객체를 생성한다

**HttpServletRequest** - 요청할 때 가지고 들어온 다양한 정보들이 담긴 객체

**HttpServletResponse**  - 접속해서 요청해온 클라이언트에게 응답해줄 정보들이 담긴 객체

이렇게 생성된 두 개의 객체를 요청 정보에 있는 path로 매핑된 서블릿에게 전달하게 된다.

이렇게 전달한 객체는 service(), doGet(), doPost() 등의 기능을 가진 메서드에 파라미터로 전달돼서 사용된다.

두 객체에 대해 자세히 알아보자

**HttpServletRequest**

- http프로토콜의 request정보를 서블릿에게 전달하기 위한 목적으로 사용한다.
- 헤더정보, 파라미터, 쿠키, URI, URL 등의 정보를 읽어 들이는 메소드를 가지고 있다.
- Body의 Stream을 읽어들이는 메소드를 가지고 있다.

**HttpServletResponse** 

- WAS는 어떤 클라이언트가 요청을 보냈는지, 해당 클라이언트에게 응답을 보내기 위한 HttpServletResponse객체를 생성하여 서블릿에게 전달한다.
- 서블릿은 해당 객체를 이용하여 content type, 응답코드, 응답 메시지 등을 전송한다.



요청과 응답의 순서를 다시 정리해보자

1. 웹 브라우저가 WAS에게 서블릿 요청
2. 요청할 때 가지고 있는 정보를 HttpServletRequest 객체로 생성하여 저장
3. 웹 브라우저에게 응답을 보낼 때 사용하기 위해 HttpServletResponse 객체를 생성
4. 생성된 두 객체HttpServletRequest , HttpServletResponse 를 서블릿에게 전달한다.



클라이언트가 서버에게 요청을 보낼 때 많은 정보들을 포함한다고 했는데,

구체적으로 어떤 정보들이 포함되어있을까?

1. 요청할 때 가지고 들어오는 헤더 정보

   웹 브라우저가 요청정보에 담아서 보내는 header값을 읽어들여 브라우저 화면에 출력한다.

